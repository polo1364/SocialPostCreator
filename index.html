<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI é©…å‹•çš„ç¤¾ç¾¤åª’é«”è²¼æ–‡ç”¢ç”Ÿå™¨ï¼Œä½¿ç”¨ Gemini AI ç‚ºæ‚¨çš„ç…§ç‰‡ç”Ÿæˆå°ˆæ¥­è²¼æ–‡">
    <title>AI ç¤¾ç¾¤è²¼æ–‡ç”¢ç”Ÿå™¨ | Social Post Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            box-sizing: border-box;
        }
        
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .dark-glass {
            background: rgba(26, 26, 46, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-text {
            background: linear-gradient(135deg, #e94560 0%, #ff6b6b 50%, #ffd93d 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .accent-gradient {
            background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
        }

        .animate-fade-up {
            animation: fadeUp 0.6s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .upload-area {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(233, 69, 96, 0.1) 0%, rgba(255, 107, 107, 0.1) 100%);
            border: 2px dashed rgba(233, 69, 96, 0.4);
        }

        .upload-area:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(233, 69, 96, 0.2);
            border-color: #e94560;
        }

        .upload-area.dragover {
            border-color: #e94560;
            background: rgba(233, 69, 96, 0.2);
            transform: scale(1.02);
        }

        .btn-primary {
            background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(233, 69, 96, 0.4);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            transition: all 0.3s ease;
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(15, 52, 96, 0.4);
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .result-card {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        }

        .result-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .copy-btn {
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            transform: scale(1.05);
        }

        .toast {
            animation: toastSlideIn 0.3s ease-out;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* é¢¨æ ¼é¸æ“‡å™¨ */
        .style-chip {
            transition: all 0.2s ease;
            cursor: pointer;
            user-select: none;
            flex-shrink: 0;
        }

        @media (max-width: 640px) {
            .style-chip {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
            .style-chip .style-emoji {
                font-size: 1rem;
            }
        }

        .style-chip:hover {
            transform: translateY(-2px);
        }

        .style-chip.selected {
            background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(233, 69, 96, 0.3);
        }

        .style-chip.selected .style-emoji {
            transform: scale(1.2);
        }

        /* åº—å®¶è³‡è¨Šå¡ç‰‡ */
        .store-info-card {
            background: linear-gradient(135deg, rgba(233, 69, 96, 0.1) 0%, rgba(255, 217, 61, 0.1) 100%);
            border: 1px solid rgba(233, 69, 96, 0.3);
        }

        /* æœå°‹æŒ‰éˆ•å‹•ç•« */
        .search-btn {
            transition: all 0.3s ease;
        }

        .search-btn:hover:not(:disabled) {
            background: #e94560;
        }

        .search-btn.loading {
            animation: searchPulse 1s ease-in-out infinite;
        }

        @keyframes searchPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* æ¨™ç±¤æ¨£å¼ */
        .info-tag {
            background: rgba(233, 69, 96, 0.1);
            color: #e94560;
        }

        /* æ»¾å‹•æ¢æ¨£å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(233, 69, 96, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(233, 69, 96, 0.7);
        }

        /* é¢¨æ ¼æ¨™ç±¤é¡è‰² */
        .style-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 9999px;
        }
        
        /* æ–‡å­—æˆªæ–· */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="min-h-screen py-4 sm:py-8 px-3 sm:px-4">
    
    <!-- API Key æ¨¡æ…‹è¦–çª— -->
    <div id="key-modal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center hidden">
        <div class="modal-content glass-effect rounded-3xl w-full max-w-md mx-4 p-8 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 accent-gradient rounded-2xl flex items-center justify-center text-white text-2xl shadow-lg mx-auto mb-4">
                    <i class="fas fa-key"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">è¨­å®š API Key</h2>
                <p class="text-sm text-gray-600">è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key</p>
                <p class="text-xs text-gray-500 mt-2">
                    <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-pink-600 hover:underline">
                        é‚„æ²’æœ‰ API Keyï¼Ÿé»æ­¤å–å¾—
                    </a>
                </p>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-lock mr-2"></i>API Key
                </label>
                <input 
                    type="password" 
                    id="api-key-input" 
                    class="w-full border-2 border-gray-200 rounded-xl p-4 focus:border-pink-500 focus:ring-2 focus:ring-pink-200 outline-none transition text-gray-800 font-mono text-sm"
                    placeholder="è¼¸å…¥æ‚¨çš„ Gemini API Key..."
                    autocomplete="off"
                >
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-shield-alt mr-1"></i>æ‚¨çš„ API Key åƒ…å„²å­˜åœ¨æœ¬åœ°ç€è¦½å™¨ï¼Œä¸æœƒä¸Šå‚³åˆ°ä¼ºæœå™¨
                </p>
            </div>
            
            <div class="flex gap-3">
                <button 
                    onclick="saveKey()" 
                    class="flex-1 btn-primary text-white py-3 rounded-xl font-semibold shadow-lg"
                >
                    <i class="fas fa-check mr-2"></i>å„²å­˜
                </button>
                <button 
                    onclick="closeKeyModal()" 
                    class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition"
                >
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="max-w-4xl mx-auto">
        
        <!-- æ¨™é¡Œå€ -->
        <header class="text-center mb-6 sm:mb-8 animate-fade-up">
            <div class="inline-flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 accent-gradient rounded-2xl sm:rounded-3xl shadow-xl mb-4 sm:mb-6 rotate-3 hover:rotate-6 transition-transform">
                <i class="fas fa-magic text-3xl sm:text-4xl text-white"></i>
            </div>
            <h1 class="text-2xl sm:text-4xl md:text-5xl font-bold text-white mb-2 sm:mb-3 px-2">
                AI ç¤¾ç¾¤è²¼æ–‡ç”¢ç”Ÿå™¨
            </h1>
            <p class="text-white/80 text-sm sm:text-lg md:text-xl px-2">
                æ™ºæ…§æœå°‹åº—å®¶è³‡è¨Šï¼Œç”Ÿæˆå¤šæ¨£åŒ–çœŸå¯¦è²¼æ–‡
            </p>
            <div class="mt-3 sm:mt-4 flex items-center justify-center gap-2 sm:gap-4 text-white/70 text-xs sm:text-sm flex-wrap px-2">
                <span><i class="fas fa-robot mr-1"></i>Gemini AI</span>
                <span><i class="fas fa-search mr-1"></i>æ™ºæ…§æœå°‹</span>
                <span><i class="fas fa-palette mr-1"></i>å¤šé¢¨æ ¼</span>
            </div>
        </header>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <div class="glass-effect rounded-2xl sm:rounded-3xl p-4 sm:p-6 md:p-8 shadow-2xl mb-6 animate-fade-up" style="animation-delay: 0.1s">
            
            <!-- åœ–ç‰‡ä¸Šå‚³å€ -->
            <label for="file-upload" class="cursor-pointer block mb-6">
                <div id="upload-box" class="upload-area rounded-xl sm:rounded-2xl p-4 sm:p-8 text-center relative overflow-hidden min-h-[200px] sm:min-h-[280px] flex flex-col justify-center items-center">
                    <img id="preview-img" class="hidden max-h-full max-w-full object-contain rounded-xl shadow-lg">
                    <div id="upload-placeholder" class="text-gray-600">
                        <div class="w-16 h-16 sm:w-20 sm:h-20 accent-gradient rounded-2xl flex items-center justify-center mb-3 sm:mb-4 mx-auto shadow-lg">
                            <i class="fas fa-cloud-upload-alt text-3xl sm:text-4xl text-white"></i>
                        </div>
                        <p class="text-base sm:text-lg font-semibold mb-2">é»æ“Šæˆ–æ‹–æ”¾ä¸Šå‚³ç…§ç‰‡</p>
                        <p class="text-xs sm:text-sm text-gray-500">æ”¯æ´ JPGã€PNGã€GIFã€WebPï¼ˆæœ€å¤§ 10MBï¼‰</p>
                    </div>
                </div>
            </label>
            <input id="file-upload" type="file" class="hidden" accept="image/*" onchange="previewImage(event)">
            
            <!-- åº—å®¶/æ™¯é»æœå°‹å€ -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-3">
                    <i class="fas fa-search-location mr-2 text-pink-600"></i>
                    åº—å®¶æˆ–æ™¯é»åç¨±ï¼ˆé¸å¡«ï¼Œè‡ªå‹•æœå°‹ç¶²è·¯è³‡è¨Šï¼‰
                </label>
                
                <!-- é¡å‹åˆ‡æ› -->
                <div class="flex gap-2 mb-3">
                    <button 
                        id="type-store-btn"
                        onclick="setPlaceType('store')"
                        class="place-type-btn flex-1 py-2 px-3 sm:px-4 rounded-xl font-semibold text-xs sm:text-sm transition flex items-center justify-center gap-1 sm:gap-2 bg-pink-600 text-white"
                    >
                        <i class="fas fa-store"></i>
                        <span>åº—å®¶/é¤å»³</span>
                    </button>
                    <button 
                        id="type-attraction-btn"
                        onclick="setPlaceType('attraction')"
                        class="place-type-btn flex-1 py-2 px-3 sm:px-4 rounded-xl font-semibold text-xs sm:text-sm transition flex items-center justify-center gap-1 sm:gap-2 bg-gray-200 text-gray-700 hover:bg-gray-300"
                    >
                        <i class="fas fa-mountain"></i>
                        <span>æ™¯é»/æ—…éŠ</span>
                    </button>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-2">
                    <div class="flex gap-2 flex-1">
                        <input 
                            type="text" 
                            id="place-name" 
                            class="flex-1 min-w-0 border-2 border-gray-200 rounded-xl p-3 sm:p-4 focus:border-pink-500 focus:ring-2 focus:ring-pink-200 outline-none bg-white text-gray-800 placeholder-gray-400 transition text-sm sm:text-base"
                            placeholder="åº—å®¶æˆ–æ™¯é»åç¨±..."
                        >
                        <input 
                            type="text" 
                            id="place-location" 
                            class="w-20 sm:w-28 border-2 border-gray-200 rounded-xl p-3 sm:p-4 focus:border-pink-500 focus:ring-2 focus:ring-pink-200 outline-none bg-white text-gray-800 placeholder-gray-400 transition text-sm sm:text-base"
                            placeholder="åœ°å€"
                        >
                    </div>
                    <button 
                        id="search-place-btn"
                        onclick="searchPlace()" 
                        class="search-btn px-4 sm:px-6 py-3 sm:py-4 bg-gray-800 text-white rounded-xl font-semibold hover:bg-pink-600 transition flex items-center justify-center gap-2 shrink-0"
                    >
                        <i class="fas fa-search"></i>
                        <span>æœå°‹</span>
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>è¼¸å…¥åº—å®¶æˆ–æ™¯é»åç¨±å¾Œé»æ“Šæœå°‹ï¼ŒAI æœƒè‡ªå‹•æŸ¥è©¢ç›¸é—œè³‡è¨Šè®“è²¼æ–‡æ›´çœŸå¯¦
                </p>
            </div>

            <!-- åº—å®¶/æ™¯é»è³‡è¨Šé¡¯ç¤ºå€ -->
            <div id="place-info-container" class="hidden mb-6">
                <div class="store-info-card rounded-2xl p-5">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div id="place-icon" class="w-10 h-10 accent-gradient rounded-xl flex items-center justify-center text-white">
                                <i class="fas fa-store"></i>
                            </div>
                            <div>
                                <h4 id="place-display-name" class="font-bold text-gray-800">åç¨±</h4>
                                <p id="place-display-type" class="text-sm text-gray-600"></p>
                            </div>
                        </div>
                        <button onclick="clearPlaceInfo()" class="text-gray-400 hover:text-red-500 transition">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="place-details" class="space-y-2 text-sm text-gray-700">
                        <!-- å‹•æ…‹å¡«å…… -->
                    </div>
                </div>
            </div>

            <!-- æè¿°è¼¸å…¥å€ -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-3">
                    <i class="fas fa-comment-dots mr-2 text-pink-600"></i>
                    é€™å¼µç…§ç‰‡æƒ³è¡¨é”ä»€éº¼ï¼Ÿï¼ˆç°¡çŸ­æè¿°ï¼‰
                </label>
                <textarea 
                    id="user-desc" 
                    rows="3" 
                    class="w-full border-2 border-gray-200 rounded-xl p-4 focus:border-pink-500 focus:ring-2 focus:ring-pink-200 outline-none resize-none bg-white text-gray-800 placeholder-gray-400 transition"
                    placeholder="ä¾‹å¦‚ï¼šä»Šå¤©è·Ÿå¥½ä¹…ä¸è¦‹çš„æœ‹å‹å»åƒæ—©åˆé¤ï¼Œè¶…é–‹å¿ƒï¼æˆ–æ˜¯ï¼šçµ‚æ–¼åƒåˆ°å¤¢å¯ä»¥æ±‚çš„ç”œé»..."
                ></textarea>
            </div>

            <!-- æ˜Ÿç´šè©•åˆ†å€ -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-3">
                    <i class="fas fa-star mr-2 text-pink-600"></i>
                    æ•´é«”è©•åƒ¹æ˜Ÿç´šï¼ˆé¸å¡«ï¼Œå½±éŸ¿è²¼æ–‡èªèª¿ï¼‰
                </label>
                <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                    <div id="star-rating" class="flex gap-1 items-center">
                        <button type="button" onclick="setRating(1)" class="star-btn text-2xl sm:text-3xl transition-transform hover:scale-110" data-star="1">
                            <i class="far fa-star text-gray-300"></i>
                        </button>
                        <button type="button" onclick="setRating(2)" class="star-btn text-2xl sm:text-3xl transition-transform hover:scale-110" data-star="2">
                            <i class="far fa-star text-gray-300"></i>
                        </button>
                        <button type="button" onclick="setRating(3)" class="star-btn text-2xl sm:text-3xl transition-transform hover:scale-110" data-star="3">
                            <i class="far fa-star text-gray-300"></i>
                        </button>
                        <button type="button" onclick="setRating(4)" class="star-btn text-2xl sm:text-3xl transition-transform hover:scale-110" data-star="4">
                            <i class="far fa-star text-gray-300"></i>
                        </button>
                        <button type="button" onclick="setRating(5)" class="star-btn text-2xl sm:text-3xl transition-transform hover:scale-110" data-star="5">
                            <i class="far fa-star text-gray-300"></i>
                        </button>
                        <button type="button" id="clear-rating-btn" onclick="clearRating()" class="ml-2 text-xs text-gray-400 hover:text-red-500 transition hidden">
                            <i class="fas fa-times"></i> æ¸…é™¤
                        </button>
                    </div>
                    <span id="rating-text" class="text-sm text-gray-500">å¯é¸ï¼Œä¸å½±éŸ¿ç”Ÿæˆ</span>
                </div>
                <p class="mt-2 text-xs text-gray-400">
                    <i class="fas fa-info-circle mr-1"></i>é»æ“Šæ˜Ÿæ˜Ÿè©•åˆ†ï¼Œå†é»ä¸€æ¬¡å¯å–æ¶ˆã€‚1æ˜Ÿ=å¤±æœ›ã€3æ˜Ÿ=æ™®é€šã€5æ˜Ÿ=è¶…æ¨
                </p>
            </div>

            <!-- é¢¨æ ¼é¸æ“‡å€ -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-3">
                    <i class="fas fa-palette mr-2 text-pink-600"></i>
                    é¸æ“‡è²¼æ–‡é¢¨æ ¼ï¼ˆé¸æ“‡ 3-5 ç¨®ï¼‰
                </label>
                <div id="style-chips" class="flex flex-wrap gap-2">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-lightbulb mr-1"></i>é¸æ“‡ä¸åŒé¢¨æ ¼ï¼ŒAI æœƒç‚ºæ¯ç¨®é¢¨æ ¼ç”Ÿæˆç¨ç‰¹çš„è²¼æ–‡
                </p>
            </div>

            <!-- ç”ŸæˆæŒ‰éˆ• -->
            <button 
                id="generate-btn" 
                onclick="generateCaption()" 
                class="w-full btn-primary text-white py-4 rounded-xl font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed shadow-lg flex items-center justify-center gap-3"
                disabled
            >
                <i class="fas fa-magic"></i>
                <span>âœ¨ ç”Ÿæˆå¤šæ¨£åŒ–è²¼æ–‡</span>
            </button>

            <!-- API Key ç®¡ç†æŒ‰éˆ• -->
            <div class="mt-4 text-center">
                <button 
                    onclick="showKeyModal()" 
                    class="text-sm text-gray-600 hover:text-pink-600 transition flex items-center gap-2 mx-auto"
                >
                    <i class="fas fa-cog"></i>
                    <span>ç®¡ç† API Key</span>
                </button>
            </div>
        </div>

        <!-- è¼‰å…¥ä¸­ -->
        <div id="loading" class="hidden glass-effect rounded-3xl p-8 text-center shadow-xl animate-fade-up">
            <div class="w-20 h-20 accent-gradient rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse-slow">
                <i class="fas fa-robot text-3xl text-white"></i>
            </div>
            <p class="text-lg font-semibold text-gray-700 mb-2">AI æ­£åœ¨ç‚ºæ‚¨å‰µä½œå¤šæ¨£åŒ–è²¼æ–‡</p>
            <p class="text-sm text-gray-500 loading-dots">è«‹ç¨å€™</p>
        </div>

        <!-- çµæœå€ -->
        <div id="result-area" class="hidden animate-fade-up" style="animation-delay: 0.2s">
            <div class="glass-effect rounded-3xl p-4 sm:p-6 md:p-8 shadow-2xl">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-6">
                    <h3 class="text-xl sm:text-2xl font-bold text-gray-800 flex items-center gap-2 sm:gap-3">
                        <div class="w-8 h-8 sm:w-10 sm:h-10 accent-gradient rounded-xl flex items-center justify-center text-white shrink-0">
                            <i class="fas fa-sparkles text-sm sm:text-base"></i>
                        </div>
                        <span>ç‚ºæ‚¨ç”Ÿæˆçš„è²¼æ–‡</span>
                    </h3>
                    <button 
                        onclick="generateCaption()" 
                        class="btn-secondary text-white px-4 py-2 rounded-xl font-semibold text-sm flex items-center justify-center gap-2 w-full sm:w-auto"
                    >
                        <i class="fas fa-sync-alt"></i>
                        é‡æ–°ç”Ÿæˆ
                    </button>
                </div>
                <div id="captions-container" class="space-y-4"></div>
            </div>
        </div>

    </div>

    <!-- æ­·å²è¨˜éŒ„æ¨¡æ…‹è¦–çª— -->
    <div id="history-modal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center hidden overflow-y-auto py-4">
        <div class="modal-content glass-effect rounded-3xl w-full max-w-2xl mx-4 p-6 sm:p-8 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-history text-pink-600"></i>
                    æ­·å²è¨˜éŒ„
                </h2>
                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="history-container" class="space-y-4">
                <!-- å‹•æ…‹å¡«å…… -->
            </div>
            
            <div class="mt-6 flex flex-col sm:flex-row gap-3">
                <button 
                    onclick="closeHistoryModal()" 
                    class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition"
                >
                    é—œé–‰
                </button>
                <button 
                    onclick="clearHistory()" 
                    class="py-3 px-6 bg-red-100 text-red-600 rounded-xl font-semibold hover:bg-red-200 transition flex items-center justify-center gap-2"
                >
                    <i class="fas fa-trash"></i>
                    æ¸…é™¤å…¨éƒ¨
                </button>
            </div>
        </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast" class="fixed top-4 left-4 right-4 sm:left-auto sm:right-4 sm:max-w-sm glass-effect rounded-xl px-4 sm:px-6 py-3 sm:py-4 shadow-2xl hidden toast z-50">
        <div class="flex items-center gap-2 sm:gap-3">
            <i id="toast-icon" class="fas fa-check-circle text-green-500 text-lg sm:text-xl shrink-0"></i>
            <span id="toast-message" class="text-gray-800 font-semibold text-sm sm:text-base"></span>
        </div>
    </div>

    <script>
        let apiKey = localStorage.getItem('gemini_api_key');
        let selectedFile = null;
        let currentPlaceInfo = null;
        let currentPlaceType = 'store'; // 'store' æˆ– 'attraction'
        let selectedStyles = ['humorous', 'warm', 'foodie'];
        let currentRating = 0; // 0 è¡¨ç¤ºæœªé¸æ“‡
        let captionsHistory = []; // è²¼æ–‡æ­·å²è¨˜éŒ„
        
        // æ˜Ÿç´šå°æ‡‰çš„æ–‡å­—æè¿°
        const RATING_TEXTS = {
            0: 'å¯é¸ï¼Œä¸å½±éŸ¿ç”Ÿæˆ',
            1: 'ğŸ˜ å¤±æœ›ï¼Œä¸æ¨è–¦',
            2: 'ğŸ˜• æ™®é€šåä¸‹ï¼Œæœ‰å¾…åŠ å¼·',
            3: 'ğŸ˜ é‚„å¯ä»¥ï¼Œä¸­è¦ä¸­çŸ©',
            4: 'ğŸ˜Š ä¸éŒ¯ï¼Œå€¼å¾—ä¸€è©¦',
            5: 'ğŸ¤© è¶…è®šï¼Œå¤§åŠ›æ¨è–¦ï¼'
        };
        
        // ===== æš«å­˜åŠŸèƒ½ =====
        const STORAGE_KEYS = {
            description: 'post_creator_description',
            styles: 'post_creator_styles',
            rating: 'post_creator_rating',
            placeInfo: 'post_creator_place_info',
            placeType: 'post_creator_place_type',
            placeName: 'post_creator_place_name',
            placeLocation: 'post_creator_place_location',
            history: 'post_creator_history'
        };
        
        // å„²å­˜åˆ°æš«å­˜
        function saveToStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.warn('å„²å­˜æš«å­˜å¤±æ•—:', e);
            }
        }
        
        // å¾æš«å­˜è®€å–
        function loadFromStorage(key, defaultValue = null) {
            try {
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : defaultValue;
            } catch (e) {
                console.warn('è®€å–æš«å­˜å¤±æ•—:', e);
                return defaultValue;
            }
        }
        
        // å„²å­˜æ‰€æœ‰è¼¸å…¥ç‹€æ…‹
        function saveInputState() {
            const desc = document.getElementById('user-desc').value;
            const placeName = document.getElementById('place-name').value;
            const placeLocation = document.getElementById('place-location').value;
            
            saveToStorage(STORAGE_KEYS.description, desc);
            saveToStorage(STORAGE_KEYS.styles, selectedStyles);
            saveToStorage(STORAGE_KEYS.rating, currentRating);
            saveToStorage(STORAGE_KEYS.placeType, currentPlaceType);
            saveToStorage(STORAGE_KEYS.placeName, placeName);
            saveToStorage(STORAGE_KEYS.placeLocation, placeLocation);
            if (currentPlaceInfo) {
                saveToStorage(STORAGE_KEYS.placeInfo, currentPlaceInfo);
            }
        }
        
        // æ¢å¾©æ‰€æœ‰è¼¸å…¥ç‹€æ…‹
        function restoreInputState() {
            // æ¢å¾©æè¿°
            const savedDesc = loadFromStorage(STORAGE_KEYS.description, '');
            if (savedDesc) {
                document.getElementById('user-desc').value = savedDesc;
            }
            
            // æ¢å¾©é¢¨æ ¼é¸æ“‡
            const savedStyles = loadFromStorage(STORAGE_KEYS.styles);
            if (savedStyles && Array.isArray(savedStyles) && savedStyles.length >= 3) {
                selectedStyles = savedStyles;
            }
            
            // æ¢å¾©æ˜Ÿç´š
            const savedRating = loadFromStorage(STORAGE_KEYS.rating, 0);
            currentRating = savedRating;
            
            // æ¢å¾©æœå°‹é¡å‹
            const savedPlaceType = loadFromStorage(STORAGE_KEYS.placeType, 'store');
            currentPlaceType = savedPlaceType;
            setPlaceType(savedPlaceType);
            
            // æ¢å¾©åº—å®¶/æ™¯é»åç¨±
            const savedPlaceName = loadFromStorage(STORAGE_KEYS.placeName, '');
            const savedPlaceLocation = loadFromStorage(STORAGE_KEYS.placeLocation, '');
            if (savedPlaceName) {
                document.getElementById('place-name').value = savedPlaceName;
            }
            if (savedPlaceLocation) {
                document.getElementById('place-location').value = savedPlaceLocation;
            }
            
            // æ¢å¾©åº—å®¶/æ™¯é»è³‡è¨Š
            const savedPlaceInfo = loadFromStorage(STORAGE_KEYS.placeInfo);
            if (savedPlaceInfo && savedPlaceInfo.found) {
                currentPlaceInfo = savedPlaceInfo;
                displayPlaceInfo(savedPlaceInfo);
            }
            
            // æ¢å¾©æ­·å²è¨˜éŒ„
            captionsHistory = loadFromStorage(STORAGE_KEYS.history, []);
        }
        
        // å„²å­˜ç”Ÿæˆçµæœåˆ°æ­·å²
        function saveToHistory(captions, description) {
            const historyItem = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('zh-TW'),
                description: description,
                placeInfo: currentPlaceInfo,
                rating: currentRating,
                captions: captions
            };
            
            captionsHistory.unshift(historyItem); // æœ€æ–°çš„æ”¾æœ€å‰é¢
            
            // åªä¿ç•™æœ€è¿‘ 10 ç­†
            if (captionsHistory.length > 10) {
                captionsHistory = captionsHistory.slice(0, 10);
            }
            
            saveToStorage(STORAGE_KEYS.history, captionsHistory);
        }
        
        // æ¸…é™¤æš«å­˜
        function clearStorage() {
            Object.values(STORAGE_KEYS).forEach(key => {
                localStorage.removeItem(key);
            });
            showToast('å·²æ¸…é™¤æ‰€æœ‰æš«å­˜è³‡æ–™', 'success');
        }
        
        // é¡¯ç¤ºæ­·å²è¨˜éŒ„
        function showHistory() {
            const modal = document.getElementById('history-modal');
            const container = document.getElementById('history-container');
            
            if (captionsHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p>å°šç„¡æ­·å²è¨˜éŒ„</p>
                    </div>
                `;
            } else {
                container.innerHTML = captionsHistory.map((item, historyIndex) => `
                    <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200">
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-sm text-gray-500">
                                <i class="fas fa-clock mr-1"></i>${item.timestamp}
                            </div>
                            ${item.rating > 0 ? `<div class="text-yellow-500">${'â˜…'.repeat(item.rating)}${'â˜†'.repeat(5-item.rating)}</div>` : ''}
                        </div>
                        <p class="text-gray-700 text-sm mb-3 line-clamp-2">
                            <strong>æè¿°ï¼š</strong>${escapeHtml(item.description)}
                        </p>
                        ${item.placeInfo && item.placeInfo.name ? `
                            <p class="text-gray-600 text-xs mb-3">
                                <i class="fas fa-map-marker-alt mr-1"></i>${item.placeInfo.name}
                            </p>
                        ` : ''}
                        <div class="space-y-2">
                            ${item.captions.slice(0, 2).map((cap, capIndex) => {
                                const caption = typeof cap === 'string' ? cap : cap.caption;
                                const style = typeof cap === 'string' ? '' : cap.style;
                                return `
                                    <div class="bg-white rounded-xl p-3 text-sm">
                                        ${style ? `<span class="text-xs text-pink-600 font-medium">${style}</span>` : ''}
                                        <p class="text-gray-700 line-clamp-2 mt-1">${escapeHtml(caption)}</p>
                                        <button 
                                            onclick="copyFromHistory(${historyIndex}, ${capIndex})"
                                            class="mt-2 text-xs text-gray-500 hover:text-pink-600 transition"
                                        >
                                            <i class="far fa-copy mr-1"></i>è¤‡è£½
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                            ${item.captions.length > 2 ? `
                                <button 
                                    onclick="loadHistoryItem(${historyIndex})"
                                    class="w-full py-2 text-sm text-pink-600 hover:bg-pink-50 rounded-lg transition"
                                >
                                    æŸ¥çœ‹å…¨éƒ¨ ${item.captions.length} å‰‡è²¼æ–‡
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            modal.classList.remove('hidden');
        }
        
        // é—œé–‰æ­·å²è¨˜éŒ„
        function closeHistoryModal() {
            document.getElementById('history-modal').classList.add('hidden');
        }
        
        // å¾æ­·å²è¨˜éŒ„è¤‡è£½
        function copyFromHistory(historyIndex, captionIndex) {
            const item = captionsHistory[historyIndex];
            if (item && item.captions[captionIndex]) {
                const caption = typeof item.captions[captionIndex] === 'string' 
                    ? item.captions[captionIndex] 
                    : item.captions[captionIndex].caption;
                
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(caption).then(() => {
                        showToast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
                    }).catch(() => {
                        fallbackCopyText(caption);
                    });
                } else {
                    fallbackCopyText(caption);
                }
            }
        }
        
        // å‚™ç”¨è¤‡è£½ï¼ˆç”¨æ–¼æ­·å²è¨˜éŒ„ï¼‰
        function fallbackCopyText(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
                showToast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            } catch (err) {
                showToast('è¤‡è£½å¤±æ•—', 'error');
            }
            document.body.removeChild(textarea);
        }
        
        // è¼‰å…¥æ­·å²è¨˜éŒ„é …ç›®
        function loadHistoryItem(historyIndex) {
            const item = captionsHistory[historyIndex];
            if (item) {
                // å„²å­˜è²¼æ–‡è³‡æ–™ä¾›è¤‡è£½ä½¿ç”¨
                window.captionsData = item.captions.map(cap => 
                    typeof cap === 'string' ? cap : cap.caption
                );
                
                // é¡¯ç¤ºçµæœ
                renderResult(item.captions);
                closeHistoryModal();
                
                // æ»¾å‹•åˆ°çµæœå€
                setTimeout(() => {
                    document.getElementById('result-area').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }
        
        // æ¸…é™¤æ­·å²è¨˜éŒ„
        function clearHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„å—ï¼Ÿ')) {
                captionsHistory = [];
                saveToStorage(STORAGE_KEYS.history, []);
                closeHistoryModal();
                
                // ç§»é™¤æ­·å²è¨˜éŒ„æŒ‰éˆ•
                const historyBtn = document.getElementById('history-btn');
                if (historyBtn) {
                    historyBtn.parentElement.remove();
                }
                
                showToast('å·²æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„', 'success');
            }
        }
        
        // é¢¨æ ¼å®šç¾©
        const STYLES = {
            humorous: { name: "å¹½é»˜æç¬‘", emoji: "ğŸ˜‚", color: "bg-yellow-100 text-yellow-800" },
            warm: { name: "æº«é¦¨æ„Ÿæ€§", emoji: "ğŸ¥°", color: "bg-pink-100 text-pink-800" },
            foodie: { name: "ç¾é£Ÿå°ˆå®¶", emoji: "ğŸ˜‹", color: "bg-orange-100 text-orange-800" },
            literary: { name: "æ–‡é’è©©æ„", emoji: "ğŸ“–", color: "bg-green-100 text-green-800" },
            energetic: { name: "æ´»åŠ›ç†±æƒ…", emoji: "ğŸ‰", color: "bg-red-100 text-red-800" },
            minimalist: { name: "ç°¡ç´„ä¿è½", emoji: "âœ“", color: "bg-gray-100 text-gray-800" },
            storytelling: { name: "æ•…äº‹æ•˜è¿°", emoji: "ğŸ“", color: "bg-blue-100 text-blue-800" },
            trendy: { name: "æ½®æµç¶²ç´…", emoji: "ğŸ’…", color: "bg-purple-100 text-purple-800" }
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            if (!apiKey) {
                setTimeout(() => showKeyModal(), 300);
            }
            
            // æ¢å¾©æš«å­˜ç‹€æ…‹
            restoreInputState();
            
            renderStyleChips();
            updateRatingDisplay();
            
            // å¦‚æœæœ‰æ­·å²è¨˜éŒ„ï¼Œé¡¯ç¤ºæœ€è¿‘ä¸€ç­†
            if (captionsHistory.length > 0) {
                showHistoryButton();
            }
            
            // ç›£è½è¼¸å…¥è®ŠåŒ–ï¼Œè‡ªå‹•å„²å­˜
            document.getElementById('user-desc').addEventListener('input', debounce(saveInputState, 500));
            document.getElementById('place-name').addEventListener('input', debounce(saveInputState, 500));
            document.getElementById('place-location').addEventListener('input', debounce(saveInputState, 500));
        });
        
        // é˜²æŠ–å‡½æ•¸
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        
        // é¡¯ç¤ºæ­·å²è¨˜éŒ„æŒ‰éˆ•
        function showHistoryButton() {
            // å¦‚æœæŒ‰éˆ•å·²å­˜åœ¨å‰‡ä¸é‡è¤‡æ·»åŠ 
            if (document.getElementById('history-btn')) return;
            
            const apiKeyBtn = document.querySelector('[onclick="showKeyModal()"]').parentElement;
            const historyBtn = document.createElement('div');
            historyBtn.className = 'mt-2 text-center';
            historyBtn.innerHTML = `
                <button 
                    id="history-btn"
                    onclick="showHistory()" 
                    class="text-sm text-gray-600 hover:text-pink-600 transition flex items-center gap-2 mx-auto"
                >
                    <i class="fas fa-history"></i>
                    <span>æ­·å²è¨˜éŒ„ (${captionsHistory.length})</span>
                </button>
            `;
            apiKeyBtn.parentNode.insertBefore(historyBtn, apiKeyBtn.nextSibling);
        }
        
        // è¨­å®šæ˜Ÿç´šè©•åˆ†ï¼ˆé»æ“ŠåŒä¸€å€‹æ˜Ÿæ˜Ÿå¯å–æ¶ˆé¸æ“‡ï¼‰
        function setRating(rating) {
            // å¦‚æœé»æ“Šå·²é¸çš„æ˜Ÿç´šï¼Œå‰‡å–æ¶ˆé¸æ“‡
            if (currentRating === rating) {
                currentRating = 0;
            } else {
                currentRating = rating;
            }
            updateRatingDisplay();
            saveInputState(); // è‡ªå‹•å„²å­˜
        }
        
        // æ›´æ–°æ˜Ÿç´šé¡¯ç¤º
        function updateRatingDisplay() {
            const buttons = document.querySelectorAll('.star-btn');
            const clearBtn = document.getElementById('clear-rating-btn');
            
            buttons.forEach((btn, index) => {
                const starIcon = btn.querySelector('i');
                if (index < currentRating) {
                    starIcon.className = 'fas fa-star text-yellow-400';
                } else {
                    starIcon.className = 'far fa-star text-gray-300';
                }
            });
            
            document.getElementById('rating-text').textContent = RATING_TEXTS[currentRating];
            
            // é¡¯ç¤ºæˆ–éš±è—æ¸…é™¤æŒ‰éˆ•
            if (currentRating > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
        }
        
        // æ¸…é™¤æ˜Ÿç´šè©•åˆ†
        function clearRating() {
            currentRating = 0;
            updateRatingDisplay();
        }

        // æ¸²æŸ“é¢¨æ ¼é¸æ“‡å™¨
        function renderStyleChips() {
            const container = document.getElementById('style-chips');
            container.innerHTML = Object.entries(STYLES).map(([key, style]) => `
                <div 
                    class="style-chip px-4 py-2 rounded-full border-2 border-gray-200 flex items-center gap-2 ${selectedStyles.includes(key) ? 'selected' : ''}"
                    data-style="${key}"
                    onclick="toggleStyle('${key}')"
                >
                    <span class="style-emoji text-lg">${style.emoji}</span>
                    <span class="text-sm font-medium">${style.name}</span>
                </div>
            `).join('');
        }

        // åˆ‡æ›é¢¨æ ¼é¸æ“‡
        function toggleStyle(styleKey) {
            const index = selectedStyles.indexOf(styleKey);
            if (index > -1) {
                if (selectedStyles.length > 3) {
                    selectedStyles.splice(index, 1);
                } else {
                    showToast('è‡³å°‘éœ€è¦é¸æ“‡ 3 ç¨®é¢¨æ ¼', 'error');
                    return;
                }
            } else {
                if (selectedStyles.length >= 5) {
                    showToast('æœ€å¤šåªèƒ½é¸æ“‡ 5 ç¨®é¢¨æ ¼', 'error');
                    return;
                }
                selectedStyles.push(styleKey);
            }
            renderStyleChips();
            saveInputState(); // è‡ªå‹•å„²å­˜
        }

        // é¡¯ç¤º API Key æ¨¡æ…‹
        function showKeyModal() {
            const modal = document.getElementById('key-modal');
            const input = document.getElementById('api-key-input');
            modal.classList.remove('hidden');
            setTimeout(() => input.focus(), 100);
            
            if (apiKey) {
                input.value = apiKey.substring(0, 8) + '...';
                input.type = 'text';
            }
        }

        // é—œé–‰ API Key æ¨¡æ…‹
        function closeKeyModal() {
            document.getElementById('key-modal').classList.add('hidden');
            document.getElementById('api-key-input').value = '';
            document.getElementById('api-key-input').type = 'password';
        }

        // å„²å­˜ API Key
        function saveKey() {
            const val = document.getElementById('api-key-input').value.trim();
            if (!val) {
                showToast('è«‹è¼¸å…¥ API Key', 'error');
                return;
            }
            
            if (val.includes('...') && apiKey) {
                closeKeyModal();
                return;
            }
            
            apiKey = val;
            localStorage.setItem('gemini_api_key', apiKey);
            closeKeyModal();
            showToast('API Key å·²å„²å­˜', 'success');
            checkBtnState();
        }

        // åœ–ç‰‡é è¦½
        function previewImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
                showToast('åœ–ç‰‡æª”æ¡ˆéå¤§ï¼Œè«‹é¸æ“‡å°æ–¼ 10MB çš„åœ–ç‰‡', 'error');
                return;
            }
            
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('preview-img');
                const placeholder = document.getElementById('upload-placeholder');
                img.src = e.target.result;
                img.classList.remove('hidden');
                placeholder.classList.add('hidden');
                checkBtnState();
            };
            reader.readAsDataURL(file);
        }

        // æ‹–æ”¾åŠŸèƒ½
        const uploadBox = document.getElementById('upload-box');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadBox.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadBox.addEventListener(eventName, () => uploadBox.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadBox.addEventListener(eventName, () => uploadBox.classList.remove('dragover'), false);
        });

        uploadBox.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                document.getElementById('file-upload').files = files;
                previewImage({ target: { files: files } });
            }
        });

        // åˆ‡æ›æœå°‹é¡å‹
        function setPlaceType(type) {
            currentPlaceType = type;
            const storeBtn = document.getElementById('type-store-btn');
            const attractionBtn = document.getElementById('type-attraction-btn');
            const nameInput = document.getElementById('place-name');
            
            const baseClass = 'place-type-btn flex-1 py-2 px-3 sm:px-4 rounded-xl font-semibold text-xs sm:text-sm transition flex items-center justify-center gap-1 sm:gap-2';
            const activeClass = baseClass + ' bg-pink-600 text-white';
            const inactiveClass = baseClass + ' bg-gray-200 text-gray-700 hover:bg-gray-300';
            
            if (type === 'store') {
                storeBtn.className = activeClass;
                attractionBtn.className = inactiveClass;
                nameInput.placeholder = 'åº—å®¶æˆ–æ™¯é»åç¨±...';
            } else {
                attractionBtn.className = activeClass;
                storeBtn.className = inactiveClass;
                nameInput.placeholder = 'æ™¯é»åç¨±...';
            }
        }

        // æœå°‹åº—å®¶/æ™¯é»
        async function searchPlace() {
            const placeName = document.getElementById('place-name').value.trim();
            const location = document.getElementById('place-location').value.trim();
            const typeLabel = currentPlaceType === 'store' ? 'åº—å®¶' : 'æ™¯é»';
            
            if (!placeName) {
                showToast(`è«‹è¼¸å…¥${typeLabel}åç¨±`, 'error');
                return;
            }

            if (!apiKey) {
                showToast('è«‹å…ˆè¨­å®š API Key', 'error');
                showKeyModal();
                return;
            }

            const btn = document.getElementById('search-place-btn');
            btn.classList.add('loading');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const res = await fetch('/api/search-place', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey 
                    },
                    body: JSON.stringify({ 
                        placeName, 
                        location, 
                        placeType: currentPlaceType 
                    })
                });

                const data = await res.json();
                
                if (data.placeInfo && data.placeInfo.found) {
                    currentPlaceInfo = data.placeInfo;
                    displayPlaceInfo(data.placeInfo);
                    showToast(`å·²æ‰¾åˆ°${typeLabel}è³‡è¨Šï¼`, 'success');
                } else {
                    showToast(`æ‰¾ä¸åˆ°æ­¤${typeLabel}çš„è©³ç´°è³‡è¨Šï¼Œä½†ä»å¯ç”Ÿæˆè²¼æ–‡`, 'info');
                    currentPlaceInfo = null;
                    document.getElementById('place-info-container').classList.add('hidden');
                }

            } catch (e) {
                console.error(e);
                showToast('æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i><span>æœå°‹</span>';
            }
        }

        // é¡¯ç¤ºåº—å®¶/æ™¯é»è³‡è¨Š
        function displayPlaceInfo(info) {
            const container = document.getElementById('place-info-container');
            const isAttraction = info.category === 'attraction';
            
            document.getElementById('place-display-name').textContent = info.name;
            document.getElementById('place-display-type').textContent = info.type || '';
            
            // æ›´æ–°åœ–ç¤º
            const iconEl = document.getElementById('place-icon');
            iconEl.innerHTML = isAttraction 
                ? '<i class="fas fa-mountain"></i>' 
                : '<i class="fas fa-store"></i>';
            
            let detailsHtml = '';
            
            if (info.signature) {
                const label = isAttraction ? 'ç‰¹è‰²' : 'æ‹›ç‰Œ';
                detailsHtml += `<p><i class="fas fa-star text-yellow-500 mr-2"></i><strong>${label}ï¼š</strong>${info.signature}</p>`;
            }
            if (info.location) {
                detailsHtml += `<p><i class="fas fa-map-marker-alt text-red-500 mr-2"></i><strong>åœ°é»ï¼š</strong>${info.location}</p>`;
            }
            if (info.priceRange) {
                detailsHtml += `<p><i class="fas fa-dollar-sign text-green-500 mr-2"></i><strong>åƒ¹ä½ï¼š</strong>${info.priceRange}</p>`;
            }
            if (info.ticketInfo) {
                detailsHtml += `<p><i class="fas fa-ticket-alt text-blue-500 mr-2"></i><strong>é–€ç¥¨ï¼š</strong>${info.ticketInfo}</p>`;
            }
            if (info.bestTime) {
                detailsHtml += `<p><i class="fas fa-clock text-purple-500 mr-2"></i><strong>æœ€ä½³æ™‚é–“ï¼š</strong>${info.bestTime}</p>`;
            }
            if (info.nearby && info.nearby.length > 0) {
                detailsHtml += `<p><i class="fas fa-map text-indigo-500 mr-2"></i><strong>å‘¨é‚Šï¼š</strong>${info.nearby.join('ã€')}</p>`;
            }
            if (info.summary) {
                detailsHtml += `<p class="mt-2 text-gray-600 italic">"${info.summary}"</p>`;
            }
            if (info.reviews && info.reviews.length > 0) {
                detailsHtml += `<div class="flex flex-wrap gap-1 mt-2">${info.reviews.map(r => `<span class="info-tag text-xs px-2 py-1 rounded-full">${r}</span>`).join('')}</div>`;
            }
            
            document.getElementById('place-details').innerHTML = detailsHtml;
            container.classList.remove('hidden');
        }

        // æ¸…é™¤åº—å®¶/æ™¯é»è³‡è¨Š
        function clearPlaceInfo() {
            currentPlaceInfo = null;
            document.getElementById('place-info-container').classList.add('hidden');
            document.getElementById('place-name').value = '';
            document.getElementById('place-location').value = '';
        }

        // æª¢æŸ¥æŒ‰éˆ•ç‹€æ…‹
        document.getElementById('user-desc').addEventListener('input', checkBtnState);

        function checkBtnState() {
            const desc = document.getElementById('user-desc').value.trim();
            const btn = document.getElementById('generate-btn');
            btn.disabled = !(selectedFile && desc && apiKey);
        }

        // ç”Ÿæˆè²¼æ–‡
        async function generateCaption() {
            if (!selectedFile || !apiKey) return;
            const desc = document.getElementById('user-desc').value.trim();

            // UI ç‹€æ…‹æ›´æ–°
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('result-area').classList.add('hidden');
            document.getElementById('generate-btn').disabled = true;

            const formData = new FormData();
            formData.append('image', selectedFile);
            formData.append('description', desc);
            formData.append('styles', JSON.stringify(selectedStyles));
            formData.append('rating', currentRating);
            if (currentPlaceInfo) {
                formData.append('placeInfo', JSON.stringify(currentPlaceInfo));
            }

            try {
                const res = await fetch('/api/caption', {
                    method: 'POST',
                    headers: { 'x-api-key': apiKey },
                    body: formData
                });

                const data = await res.json();
                
                if (!res.ok || data.error) {
                    throw new Error(data.error || 'ç”Ÿæˆå¤±æ•—');
                }

                if (!data.captions || data.captions.length === 0) {
                    throw new Error('æœªæ”¶åˆ°æœ‰æ•ˆçš„è²¼æ–‡å…§å®¹');
                }

                renderResult(data.captions);
                
                // å„²å­˜åˆ°æ­·å²è¨˜éŒ„
                saveToHistory(data.captions, desc);
                showHistoryButton();
                
                showToast(`æˆåŠŸç”Ÿæˆ ${data.captions.length} å‰‡å¤šæ¨£åŒ–è²¼æ–‡ï¼`, 'success');

            } catch (e) {
                console.error(e);
                showToast(e.message || 'ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¨å¾Œå†è©¦', 'error');
            } finally {
                document.getElementById('loading').classList.add('hidden');
                checkBtnState();
            }
        }

        // æ¸²æŸ“çµæœ
        function renderResult(captions) {
            document.getElementById('result-area').classList.remove('hidden');
            const container = document.getElementById('captions-container');
            
            // é¢¨æ ¼é¡è‰²æ˜ å°„
            const styleColors = {
                'å¹½é»˜æç¬‘': 'bg-yellow-100 text-yellow-800',
                'æº«é¦¨æ„Ÿæ€§': 'bg-pink-100 text-pink-800',
                'ç¾é£Ÿå°ˆå®¶': 'bg-orange-100 text-orange-800',
                'æ–‡é’è©©æ„': 'bg-green-100 text-green-800',
                'æ´»åŠ›ç†±æƒ…': 'bg-red-100 text-red-800',
                'ç°¡ç´„ä¿è½': 'bg-gray-100 text-gray-800',
                'æ•…äº‹æ•˜è¿°': 'bg-blue-100 text-blue-800',
                'æ½®æµç¶²ç´…': 'bg-purple-100 text-purple-800'
            };
            
            // å„²å­˜è²¼æ–‡å…§å®¹ä¾›è¤‡è£½ä½¿ç”¨
            window.captionsData = captions.map(item => typeof item === 'string' ? item : item.caption);
            
            container.innerHTML = captions.map((item, index) => {
                const caption = typeof item === 'string' ? item : item.caption;
                const style = typeof item === 'string' ? '' : item.style;
                const colorClass = styleColors[style] || 'bg-gray-100 text-gray-800';
                
                return `
                <div class="result-card p-4 sm:p-6 rounded-2xl shadow-md border border-gray-100 relative group" style="animation-delay: ${index * 0.1}s">
                    <div class="flex items-start gap-3 sm:gap-4">
                        <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 accent-gradient rounded-xl flex items-center justify-center text-white font-bold text-sm sm:text-lg">
                            ${index + 1}
                        </div>
                        <div class="flex-1 min-w-0">
                            ${style ? `<span class="style-badge ${colorClass} mb-2 inline-block text-xs">${style}</span>` : ''}
                            <p class="text-gray-700 leading-relaxed whitespace-pre-wrap mb-4 text-sm sm:text-base break-words">${escapeHtml(caption)}</p>
                            <button 
                                data-index="${index}"
                                onclick="copyCaption(this)"
                                class="copy-btn inline-flex items-center gap-2 px-3 sm:px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-pink-100 hover:text-pink-700 font-semibold text-xs sm:text-sm transition"
                                title="è¤‡è£½è²¼æ–‡"
                            >
                                <i class="far fa-copy"></i>
                                <span>è¤‡è£½</span>
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
            
            // æ»¾å‹•åˆ°çµæœå€
            document.getElementById('result-area').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // è¤‡è£½è²¼æ–‡
        function copyCaption(btn) {
            const index = parseInt(btn.getAttribute('data-index'));
            const text = window.captionsData[index];
            
            if (!text) {
                showToast('è¤‡è£½å¤±æ•—ï¼šæ‰¾ä¸åˆ°è²¼æ–‡å…§å®¹', 'error');
                return;
            }
            
            // å˜—è©¦ä½¿ç”¨ Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopySuccess(btn);
                }).catch(() => {
                    // å¦‚æœ Clipboard API å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ³•
                    fallbackCopy(text, btn);
                });
            } else {
                // ç€è¦½å™¨ä¸æ”¯æ´ Clipboard APIï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ³•
                fallbackCopy(text, btn);
            }
        }
        
        // å‚™ç”¨è¤‡è£½æ–¹æ³•ï¼ˆä½¿ç”¨ textareaï¼‰
        function fallbackCopy(text, btn) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            textarea.style.top = '0';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess(btn);
                } else {
                    showToast('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½', 'error');
                }
            } catch (err) {
                showToast('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½', 'error');
            }
            
            document.body.removeChild(textarea);
        }
        
        // é¡¯ç¤ºè¤‡è£½æˆåŠŸ
        function showCopySuccess(btn) {
            const icon = btn.querySelector('i');
            const span = btn.querySelector('span');
            icon.className = "fas fa-check";
            span.textContent = 'å·²è¤‡è£½';
            btn.classList.add('bg-green-100', 'text-green-700');
            btn.classList.remove('bg-gray-100', 'text-gray-700');
            
            setTimeout(() => {
                icon.className = "far fa-copy";
                span.textContent = 'è¤‡è£½';
                btn.classList.remove('bg-green-100', 'text-green-700');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            }, 2000);
            
            showToast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
        }

        // é¡¯ç¤º Toast é€šçŸ¥
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const messageEl = document.getElementById('toast-message');
            
            messageEl.textContent = message;
            
            if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle text-red-500 text-xl';
            } else if (type === 'info') {
                icon.className = 'fas fa-info-circle text-blue-500 text-xl';
            } else {
                icon.className = 'fas fa-check-circle text-green-500 text-xl';
            }
            
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // HTML è½‰ç¾©
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åˆå§‹åŒ–æŒ‰éˆ•ç‹€æ…‹
        checkBtnState();
    </script>
</body>
</html>
